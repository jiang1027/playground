<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分词可视化器</title>
    <style>
        .token {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            font-family: monospace;
        }
        .token:hover {
            background-color: #e0e0e0;
        }
        .token.partial {
            background-color: #ffe0e0;
            color: #666;
        }
        .token.space {
            background-color: #e0f0ff;
        }
        .token.merged {
            background-color: #fff0e0;
            border-color: #ff9900;
        }
        #container {
            padding: 20px;
        }
        #info {
            margin: 20px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h2>分词可视化</h2>
        <div style="margin-bottom: 15px;">
            <textarea id="input-text" style="width: 100%; height: 8em; padding: 8px; box-sizing: border-box; font-family: inherit; margin-bottom: 10px;" placeholder="请输入文本..."></textarea>
            <br>
            <button id="analyze-btn" style="padding: 6px 12px; cursor: pointer;">分析 Token</button>
        </div>
        <div id="info"></div>
        <div id="tokens-display"></div>
    </div>
    <script type="module">
        import { getEncoding } from "https://esm.sh/js-tiktoken";

        const encoding = getEncoding("cl100k_base");
        const info = document.getElementById('info');
        const display = document.getElementById('tokens-display');
        const inputText = document.getElementById('input-text');
        const analyzeBtn = document.getElementById('analyze-btn');

        function visualizeTokens(text) {
            display.innerHTML = ''; // Clear previous results
            const tokens = encoding.encode(text);
            
            if (tokens.length < 1000) {
                console.log('原始文本:', text);
                console.log('Token IDs:', tokens);
            } else {
                console.log(`Text length: ${text.length}, Tokens: ${tokens.length}`);
            }
            
            // 显示信息
            info.innerHTML = `
                <strong>Token 数量:</strong> ${tokens.length}<br>
            `;
            
            const fragment = document.createDocumentFragment();
            let pendingTokens = [];

            for (let i = 0; i < tokens.length; i++) {
                const currentToken = tokens[i];
                pendingTokens.push(currentToken);
                
                // 优化：只解码当前累积的 tokens，而不是从头解码
                const groupText = encoding.decode(pendingTokens);
                const isLastToken = i === tokens.length - 1;
                
                // 如果当前解码出的文本以乱码结尾，且不是最后一个token，则认为是未完成的字符，继续累积
                if (groupText.endsWith('\uFFFD') && !isLastToken) {
                    continue;
                }
                
                // 创建显示元素
                const span = document.createElement('span');
                span.className = 'token';
                
                let displayText = groupText;
                
                // 如果包含乱码，标记颜色，并移除乱码符号以便显示
                if (groupText.includes('\uFFFD')) {
                    span.className += ' partial';
                    displayText = groupText.replace(/\uFFFD/g, '');
                }
                
                // 处理特殊字符显示
                if (displayText === '') {
                    displayText = `∅`;
                    if (!span.className.includes('partial')) span.className += ' partial';
                } else if (displayText === ' ') {
                    displayText = '␣';
                    span.className += ' space';
                } else if (displayText === '\n') {
                    displayText = '↵';
                } else if (displayText === '\t') {
                    displayText = '⇥';
                }
                
                span.textContent = displayText;
                span.title = `Tokens: [${pendingTokens.join(', ')}]\nText: "${groupText}"`;
                
                // 添加所有累积的 ID 下标
                pendingTokens.forEach(token => {
                    const sub = document.createElement('sub');
                    sub.textContent = `[${token}]`;
                    sub.style.fontSize = '10px';
                    sub.style.color = '#666';
                    sub.style.marginLeft = '2px';
                    span.appendChild(sub);
                });
                
                fragment.appendChild(span);
                
                // 重置
                pendingTokens = [];
            }
            
            display.appendChild(fragment);
            
            // 验证解码
            const reconstructed = encoding.decode(tokens);
            console.log('重建文本是否匹配:', reconstructed === text);
        }

        analyzeBtn.addEventListener('click', () => {
            visualizeTokens(inputText.value);
        });

        // Initial run
        const defaultText = `Hello World! 这里的每一个色块代表一个独立的 Token。`;
        inputText.value = defaultText;
        visualizeTokens(defaultText);
    </script>
</body>
</html>